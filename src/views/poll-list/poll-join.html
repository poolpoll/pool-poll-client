<dom-module id="poll-join">
  <template>
    <style>
      .flex {
        @apply(--layout-flex);
      }
      .vertical {
        @apply(--layout-vertical);
      }
    </style>
    <custom-ajax
      id="get-questions-ajax"
      method="get"
      last-response="{{questionList}}">
    </custom-ajax>

    <iron-pages class="vertical flex" id="container" selected="[[selectedPage]]"></iron-pages>
  </template>
  <script>
    Polymer({
      is: 'poll-join',

      properties: {
        selectedPage: {
          type: Number,
          value: 0
        },

        poll: {
          type: Object,
          observer: '_pollChanged'
        },

        questionList: {
          type: Array,
          observer: '_questionListChanged'
        }
      },

      ready: function() {
        document.addEventListener('poll-join-selected', function(event) {
          this.poll = event.detail;
        }.bind(this));

        document.addEventListener('poll-join-next', function(event) {
          this.pollJoinNext();
        }.bind(this));

        document.addEventListener('poll-join-previous', function(event) {
          this.pollJoinPrevious();
        }.bind(this));
      },

      _pollChanged: function(poll) {
        var getQuestionsAjax = this.$['get-questions-ajax'];
        getQuestionsAjax.resourceUrl = 'questions/' + poll.id;
        getQuestionsAjax.generateRequest();
      },

      _questionListChanged: function(questionList) {
        questionList.forEach(function(questionInfo) {
          var pollJoinDetail = document.createElement('poll-join-detail');
          pollJoinDetail.questionInfo = questionInfo;
          this.$['container'].appendChild(pollJoinDetail);
        }.bind(this));
      },

      pollJoinNext: function() {
        if(this.selectedPage < this.questionList.length - 1) {
          this.selectedPage++;
        } else if (this.selectedPage == this.questionList.length - 1) {
          if(this.checkValidations()) this.saveAnswers();
        }
      },

      pollJoinPrevious: function() {
        if(this.selectedPage > 0) this.selectedPage--;
      },

      checkValidations: function() {
        var pollJoinDetails = this.$['container'].children;

        for(var i = 0; i <= this.questionList.length - 1; i++) {
          if(!pollJoinDetails[i].checkValidation()) {
            this.selectedPage = i;
            return false;
          }
        }
        return true;
      },

      saveAnswers: function() {
        var pollJoinDetails = this.$['container'].children;

        for(var i=0; i <= this.questionList.length - 1; i++) {
          pollJoinDetails[i].saveAnswer();
        };
      }
    })
  </script>
</dom-module>
