<dom-module id="profile-view">
	<template>
		<style>
			:host {
				@apply(--layout-flex);
				@apply(--layout-vertical);
			}
			.header {
				@apply(--layout-horizontal);
				padding: 10px;
			}
			.body {
				@apply(--layout-vertical);
				@apply(--layout-flex);
				height: 300px;
				padding: 3%;
			}
			.body-content {
				@apply(--layout-vertical);
				@apply(--layout-flex);
			}
			.left-section {
				@apply(--layout-vertical);
				padding-right: 10px;
			}
			.left-section .image-section {
				@apply(--layout-horizontal);
				@apply(--layout-center);
				@apply(--layout-flex);
			}
			iron-image {
				width: 100px;
				height: 100px;
				border-radius: 100%;
			}
			.left-section paer-button {
				@apply(--layout-end);
			}
			.right-section {
				@apply(--layout-vertical);
				@apply(--layout-flex-3);
			}
			.label {
				padding-left: 3%;
			}
			section {
				@apply(--layout-vertical);
				width: 100%;
				height: 250px;
			}
			section paper-dialog-scrollable {
		    @apply(--layout-flex);
				overflow-x: hidden;
				background: white;
		  }
			.favorite-list {
				padding: 3%;
			}
			paper-button {
				@apply(--layout-flex);
			}
		</style>

		<custom-ajax
			id="update-user-info"
			method="POST"
			content-type="application/json">
		</custom-ajax>

		<custom-ajax
			id="user-category-ajax"
			method="GET"
			last-response="{{userCategories}}">
		</custom-ajax>

		<custom-ajax
      id="delete-category-ajax"
      method="DELETE">
    </custom-ajax>

    <custom-ajax
    	id="file-upload-ajax"
    	method="POST">
  	</custom-ajax>

  	<form id="file-form" method="POST">
    	<input id="file-input" type="file" name="profile-image" on-change="_fileInputChanged" hidden>
    </form>

		<div class="header">
			<div class="left-section">
				<div class="image-section">
					<iron-image src="[[imageSrc]]" on-tap="changeProfilePicture"></iron-image>
				</div>
				<paper-button id="save-btn" on-tap="saveBtnTapped">Save</paper-button>
			</div>

			<div class="right-section">
				<paper-input label="Name" value="{{name}}"></paper-input>
				<paper-input label="E-Mail" value="{{email}}"></paper-input>
				<paper-input label="Birth Date" value="{{birthDate}}" type="date"></paper-input>
				<paper-input label="Gender" value="{{gender}}"></paper-input>
			</div>
		</div>

		<span class="label">My Favorite List</span>

		<div class="favorite-list">
			<section>
			  <paper-dialog-scrollable>
					<template is="dom-repeat" items="{{userCategories}}">
						<iron-swipeable-container>
						  <paper-item id="[[item.id]]">[[item.name]] / [[item.description]]</paper-item>
						</iron-swipeable-container>
					</template>
			  </paper-dialog-scrollable>
			</section>
		</div>

		<paper-button on-tap="addCategory">ADD</paper-button>
	</template>
	<script>
		Polymer({
			is: 'profile-view',

			properties: {

				resourceUrl: {
					type: String
				},

				userInfo: {
					type: Object,
					observer: 'userInfoChanged'
				},

				imageSrc: {
					type: String,
					value: 'http://lorempixel.com/600/400'
				}
			},

			listeners: {
				'iron-swipe': 'itemSwiped',
				'delete-category-ajax.response': 'deleteCategoryResponsed'
			},

			ready: function() {
				document.addEventListener('category-changed', function() {
					this.refreshUserInfo();
				}.bind(this));

				this.userInfo = JSON.parse(localStorage.getItem('userInfo'));
			},

			userInfoChanged: function(userInfo) {
				if(userInfo && userInfo.id) {
					this.name =  userInfo.name;
					this.email = userInfo.email;
					this.birthDate = userInfo.birthDate;
					this.gender = userInfo.gender;
					this.imageSrc = userInfo.attachment.path + '/' + userInfo.attachment.id + '.svg';

					var userCategoryAjax = this.$['user-category-ajax'];
					userCategoryAjax.resourceUrl = 'user_categories/' + userInfo.id;
					userCategoryAjax.generateRequest();
				}
			},

			saveBtnTapped: function() {
				var updateUserInfoAjax = this.$['update-user-info'];
				updateUserInfoAjax.resourceUrl = 'users/' + this.userInfo.id;
				var userInfo = {
					id: this.userInfo.id,
					name: this.name,
					email: this.email,
					birthDate: this.birthDate,
					gender: this.gender
				};
				this.fire('set-storage', { key: 'userInfo', value: userInfo });
				updateUserInfoAjax.body = userInfo;
				updateUserInfoAjax.generateRequest();
			},

			addCategory: function() {
				var addDialog = document.createElement('profile-view-category-add');
				addDialog.userCategories = this.userCategories;
				this.fire('dialog-open', {
					content: addDialog,
					closeCallback: function() {
						this.fire('category-changed');
					},
					dialogConfig: {
						title: 'Categories',
						modal: true,
						entryAnimation: 'slide-from-left-animation',
						exitAnimation: 'slide-right-animation'
					}
				});
			},

			refreshUserInfo: function() {
				var userCategoryAjax = this.$['user-category-ajax'];
				userCategoryAjax.resourceUrl = 'user_categories/' + this.userInfo.id;
				userCategoryAjax.generateRequest();
			},

			refreshUserResponsed: function(event) {
				var userInfo = event.currentTarget.lastResponse;
				this.fire('set-storage', { key: 'userInfo', value: userInfo });
				this.userInfoChanged(userInfo)
			},

			itemSwiped: function(event) {
				var deleteCategoryId = event.detail.target.id;
				var deleteCategoryAjax = this.$['delete-category-ajax'];
				deleteCategoryAjax.resourceUrl = 'user_categories/' + this.userInfo.id + '/' + deleteCategoryId;
				deleteCategoryAjax.generateRequest();
			},

			deleteCategoryResponsed: function() {
				this.fire('category-changed');
			},

			changeProfilePicture: function() {
				this.$['file-input'].click();
			},

			_fileInputChanged: function(event) {
				var file = event.target.files[0];
				var fileForm = this.$['file-form'];
				var formData = new FormData(fileForm);
				
				var fileUploadAjax = this.$['file-upload-ajax'];
				fileUploadAjax.resourceUrl = 'users/profile/upload';
				fileUploadAjax.body = formData;
				fileUploadAjax.generateRequest();
			}
		})
	</script>
</dom-module>
