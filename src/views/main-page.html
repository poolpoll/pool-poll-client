<dom-module id="main-page">
	<template>
		<style>
			:host {
				display: block;
				@apply(--layout-flex);
				@apply(--layout-vertical);
			}
			.flex {
				@aaply(--layout-flex);
			}
			#content {
				display: flex;
				flex-direction: row;
			}
			.left-container {
				width: 100%;
				display: flex;
				flex-direction: column;
				margin: 0 1vw 2vw 2vw;
			}
			.right-container {
				width: 100%;
				display: flex;
				flex-direction: column;
				margin: 0 2vw 2vw 1vw;
			}			
		</style>
		<custom-ajax
			id="my-poll-ajax"
		 	resource-url="polls/my_polls">
	 	</custom-ajax>

	 	<custom-ajax
	 		id="top-100-ajax"
	 		resource-url="polls/top/100">
 		</custom-ajax>

 		<custom-ajax
 			id="poll-by-tags"
 			resource-url="polls/tags">
		</custom-ajax>

		<custom-ajax
			id="search-poll-ajax"
			resource-url="polls/search">
		</custom-ajax>

		<custom-ajax
			id="check-poll-histories-ajax">
		</custom-ajax>

		<div id="content" class="content">
			<div class="left-container"></div>
			<div class="right-container"></div>
		</div>
	</template>
	<script>
		Polymer({
			is: 'main-page',

			properties: {
				myPollList: {
					type: Object,
					value: function() {
						return {
							items: [],
							page: 1
						}
					}
				},

				top100List: {
					type: Object,
					value: function() {
						return {
							items: [],
							page: 1
						}
					}
				},

				tagList: {
					type: Object,
					value: function() {
						return {
							items: [],
							page: 1
						}
					}
				},

				searchList: {
					type: Object,
					value: function() {
						return {
							items: [],
							page: 1
						}
					}
				}
			},

			listeners: {
				'my-poll-ajax.response': '_initReponsedData',
				'top-100-ajax.response': '_initReponsedData',
				'poll-by-tags.response': '_initReponsedData',
				'search-poll-ajax.response': '_initReponsedData',				
				'check-poll-histories-ajax.response': '_checkAjaxResponsed'
			},

			ready: function() {
				document.addEventListener('mg-tab-view-selected', function(event) {
					var currentSelectedTap = event.detail;
					if(currentSelectedTap != this.selectedTap) {
						this.selectedTap = currentSelectedTap;
						this._clearCards();
					} else {
						return;
					}

					var param = { page: 1 };

					switch (this.selectedTap) {
						case 'my-poll':
							if(!this.myPollList.items.length) { // 현재 가져온 데이터가 없을때
								this.myPollList.page = 1;
								this._myPollAjax(param);								
							} else {
								this._dataChanged(this.myPollList);
							}

							break;

						case 'top':
							if(!this.top100List.items.length) {
								this._topPollAjax();	
							} else {
								this._dataChanged(this.top100List);
							}
							
							break;

						case 'tag':
							if(!this.tagList.items || !this.tagList.items.length) {
								this.tagList.page = 1;
								this._tagPollAjax(param);
							} else {
								this._dataChanged(this.tagList);
							}
							
							break;

						case 'search-icon':
							if(this.searchList.items.length != 0) {
								this._dataChanged(this.searchList);
							}
							break;

						default:
							if(!this.myPollList.items.length) {
								this.myPollList.page = 1;
								this._myPollAjax(param);								
							} else {
								this._dataChanged(this.myPollList);
							}

							break;
					};
				}.bind(this));

				document.addEventListener('search-btn-tapped', function(event) {
					this.keyWords = event.detail;
					this.page = 1;
					var param = { name: this.keyWords, page: this.page };
					this._searchPollAjax(param);
				}.bind(this));
			},

			/**
			 * my poll request ajax
			 * @param  Object params pagination을 위한 page object
			 */
			_myPollAjax: function(params) {
				this.fire('mg-spinner-active');
				var myPollAjax = this.$['my-poll-ajax'];
				myPollAjax.params = params;
				myPollAjax.generateRequest();
			},

			/**
			 * top 100 request ajax
			 */
			_topPollAjax: function() {
				this.fire('mg-spinner-active');
				var topPollAjax = this.$['top-100-ajax'];
				topPollAjax.generateRequest();
			},

			/**
			 * tag request ajax
			 * @param  Object params pagination을 위한 page object
			 */
			_tagPollAjax: function(params) {
				this.fire('mg-spinner-active');
				var tagPollAjax = this.$['poll-by-tags'];
				tagPollAjax.params = params;
				tagPollAjax.generateRequest();
			},

			/**
			 * search request ajax
			 * @param  Object params pagination을 위한 page object
			 */
			_searchPollAjax: function(params) {
				this.fire('mg-spinner-active');
				this.searchKeywords = params.name;
				var searchPollAjax = this.$['search-poll-ajax'];
				searchPollAjax.params = params;
				searchPollAjax.generateRequest();
			},

			/**
			 * 화면 스크롤 변경시 이벤트 리스너
			 * 최하단으로 스크롤 이동시 ajax 호출 (infinite scroll)
			 */
			_scrollChanged: function(event) {
				var scrollHeight = event.target.scrollHeight;
				var clientHeight = event.target.clientHeight;
				var scrollTop = event.target.scrollTop;

				if(clientHeight + scrollTop == scrollHeight) {
					switch (this.selectedTap) {
						case 'my-poll':
							this._myPollAjax({ page: this.myPollList.page });
							break;
						case 'tag':
							this._tagPollAjax({ page: this.tagList.page });
							break;
						case 'search-icon':
							this._searchPollAjax({ page: this.searchList.page, name: this.keyWords });
							break;
					}
				}
			},

			/**
			 * poll list 카드를 리셋
			 */
			_clearCards: function() {
				var content = this.querySelector('#content');
				while(content.childElementCount) {
					content.removeChild(content.firstChild);
				};

				var leftContainer = document.createElement('div');
				var rightContainer = document.createElement('div');
				leftContainer.classList.add('left-container');
				leftContainer.classList.add('style-scope');
				leftContainer.classList.add('main-page');
				rightContainer.classList.add('right-container');
				rightContainer.classList.add('style-scope');
				rightContainer.classList.add('main-page');

				content.appendChild(leftContainer);
				content.appendChild(rightContainer);
			},


			_initReponsedData: function(event) {
				var responsedData = event.detail.response ? event.detail.response : [];

				switch (this.selectedTap) {
					case 'my-poll':
						this.myPollList.items = (this.myPollList.items.length == 0) ? responsedData : this.myPollList.items.concat(responsedData);
						this._dataChanged({
							items: responsedData,
							page: this.myPollList.page
						});

						break;

					case 'top':
						this.top100List.items = responsedData;
						this._dataChanged(this.top100List);
						break;

					case 'tag':
						this.tagList.items = (this.tagList.items.length == 0) ? responsedData : this.tagList.items.concat(responsedData);
						this._dataChanged({
							items: responsedData,
							page: this.tagList.page
						});

						break;

					case 'search-icon':
						this.searchList.items = (this.searchList.items.length == 0) ? responsedData : this.searchList.items.concat(responsedData);
						this._dataChanged({
							items: responsedData,
							page: this.searchList.page
						});

						break;
				};

				this.fire('mg-spinner-deactive');
			},

			/**
			 * ajax request를 통해 리턴 받은 data를 화면에 출력
			 * 각 poll card에 이벤트 리스너를 등록함
			 */
			_dataChanged: function(pollList) {
				var myPollInformed = localStorage.myPollInformed ? localStorage.myPollInformed : false;
				var tagInformed = localStorage.tagInformed ? localStorage.tagInformed : false;

				var data = pollList.items;
				var currentPageCnt = pollList.page;
				if(currentPageCnt == 1 && data.length == 0) {
					var infoAlert = document.createElement('info-alert');

					switch (this.selectedTap) {
						case 'my-poll':

							if(!myPollInformed) {
								infoAlert.title = '작성한 설문이 없습니다.';
								infoAlert.msg = '첫번째 설문을 작성하시겠습니까?';

								mgAlert({
									content: infoAlert,
									useConfirmButton: true,
									useCancelButton: true,
									confirmCallback: function() {
										page('/new_poll');
									},
									cancelCallback: null
								});

								localStorage.myPollInformed = true;
							};

							break;
						case 'tag':

							if(!tagInformed) {
								infoAlert.title = '설정한 Tag가 없습니다.';
								infoAlert.msg = '당신의 관심 Tag를 등록 하시겠습니까?';

								mgAlert({
									content: infoAlert,
									width: '60%',
									useConfirmButton: true,
									useCancelButton: true,
									confirmCallback: function() {
										console.log('page to profile');
									},
									cancelCallback: null
								});

								localStorage.tagInformed = true;
							};

							break;
						case 'search-icon':
							infoAlert.title = '조회 결과가 없습니다.';
							infoAlert.msg = '\'' + this.searchKeywords + '\' 의 검색 결과가 없습니다.';

							mgAlert({
								content: infoAlert,
								useConfirmButton: false,
								useCancelButton: true,
								confirmCallback: null,
								cancelCallback: null
							});

							break;
					}
				} else if (currentPageCnt > 1 && data.length == 0) {
					var infoAlert = document.createElement('info-alert');
					infoAlert.title = '조회 결과가 없습니다.';
					infoAlert.msg = '더 이상 조회할 설문이 없습니다.';

					mgAlert({
						content: infoAlert,
						useConfirmButton: false,
						useCancelButton: true,
						confirmCallback: function() {
							page('/new_poll');
						},
						cancelCallback: null
					});					
				}

				if(!data || data.length == 0) return; // 조회 결과가 없으면 return
				
				for(var i = 0; i < data.length; i++) {
					var cardElement = document.createElement('mg-image-card');
					var baseUrl = localStorage.baseUrl ? localStorage.baseUrl : 'http://localhost:3000';

					if(data[i].user.attachmentId) {
						data[i].profileSrc = baseUrl + '/attachments/preview/' + data[i].user.attachmentId;	
					}
					if(data[i].attachmentId) {
						data[i].thumbnailSrc = baseUrl + '/attachments/preview/' + data[i].attachmentId;
					}

					cardElement.setData(data[i]);
					cardElement.addEventListener('tap', function(event) {
						var selectedPoll = event.currentTarget;
						if(selectedPoll.userId == JSON.parse(sessionStorage.userInfo).id) {
							page('/polls/chart/' + selectedPoll.id);
						} else {
							var checkPollHistoriesAjax = this.$['check-poll-histories-ajax'];
							checkPollHistoriesAjax.resourceUrl = 'poll_histories/' + selectedPoll.id;
							checkPollHistoriesAjax.generateRequest();
						}
					}.bind(this));

					var leftContainerHeight = 0;
					var rightContainerHeight = 0;
					
					var leftContainerChilds = this.querySelector('.left-container').children;
					if(leftContainerChilds.length) {
						for(var x = 0; x < leftContainerChilds.length; x++) {
							leftContainerHeight = leftContainerHeight + leftContainerChilds[x].offsetHeight;
						};
					};

					var rightContainerChilds = this.querySelector('.right-container').children;
					if(rightContainerChilds.length) {
						for(var y = 0; y < rightContainerChilds.length; y++) {
							rightContainerHeight = rightContainerHeight + rightContainerChilds[y].offsetHeight;
						};
					};

					if(leftContainerHeight <= rightContainerHeight) { // 왼쪽이 짧거나 같을 때 처리
						this.querySelector('.left-container').appendChild(cardElement);
					} else { //  오른족이 짧을때 처리
						this.querySelector('.right-container').appendChild(cardElement);
					}
				}

				this.pageCtrl();
			},

			pageCtrl: function() {
				switch (this.selectedTap) {
					case 'my-poll':
						this.myPollList.page++;
						break;

					case 'tag':
						this.tagList.page++;
						break;

					case 'search-icon':
						this.searchList.page++;
						break;
				};
			},			

			_checkAjaxResponsed: function(event) {
				var pollId = event.detail.response.pollId;
				var pollHistories = event.detail.response.data;

				if(pollHistories) {
					page('/polls/chart/' + pollId);
				} else {
					page('/polls/join/' + pollId);
				}
			}			
		})
	</script>
</dom-module>
