<dom-module id="sign-up">
	<template>
		<style>
			.container {
				background: linear-gradient( to bottom, #3CB5A3, #23ACDB );
				display: flex;
				flex-direction: column;
			}
			.container div {
				display: flex;
				padding: 2vw;
				flex-direction: row;
				background-color: #FFFFFF;
				align-items: center;
			}
			.div-border-bottom {
				border-bottom: 1px solid #CBCCCB;
			}
			.div-margin-bottom {
				margin-bottom: 5vh;
			}
			.container .close-btn-container {
				display: block;
				border: none;
				background-color: transparent;
			}
			.close-btn {
				padding: 3vw;
				float: right;
				width: 5vw;
				height: 5vw;
			}
      .logo-img {
        display: block;
        margin: auto;
        height: 14vh;
      }
      .profile-img {
      	float: right;
      	margin: auto;
      	width: 30vw;
      	padding: 10vw;
      }
      .name-field {
      	border-top: 1px solid #CBCCCB;
      }
      .input-common {
      	--mg-input-border: none;
      	--mg-font-size: 15pt;
      	--mg-input-width: 100%;
      }
      .input-small {
      	--mg-input-width: 80%;
      }
      .input-center {
      	--mg-input-text-align: center;
      }
      .input-right {
      	--mg-input-text-align: right;
      }
      .common-checkbox {
      	--mg-checkbox-size: 5vw;
      	--mg-checkbox-bg: url('../../assets/images/check_box_off.png') no-repeat;
      	--mg-checkbox-bg-checked: url('../../assets/images/check_box_on.png') no-repeat;
      	padding: 0 5% 0 5%;      	
      }
      span {
      	font-size: 2.8vh;
      	width: 60vw;
      }
      .span-center {
      	text-align: center;
      	color: #979799;
      }
     	bottom-margin {
     		margin-bottom: 5vh;
     	}
      .phone-field {
      	text-align: center;
      }
      .national-code {
      	border-right: 1px solid #CBCCCB;
      }
      mg-button {
      	--mg-button-border-radius: 0px;
      	--mg-button-width: 24vw;
      	--mg-button-height: 4vh;
      	--mg-button-font-size: 2.8vh;
      	--mg-button-color: #32B6B0;
      }
      .submit-btn-field {
      	width: 100%;
      	border: 1px 0 1px 0 solid #CBCCCB;
      	flex-direction: row;
      }
		</style>
		<custom-ajax
			id="sign-up-ajax"
			resource-url="auth/sign_up"
			method="POST"
			content-type="application/json">
 		</custom-ajax>

		<div class="container">
			<div class="close-btn-container">
				<img class="close-btn" src="../../assets/images/close_icon.png"  on-tap="_closeBtnTapped" />
			</div>
			<img class="logo-img" src="../../assets/images/sign_in_logo.png" />
			<img class="profile-img" src="../../assets/images/profile_empty.png" on-tap="changeProfilePicture" />
			<input id="upload-input" type="file" on-change="_fileSelected" accept="image/*" hidden>

			<div class="div-border-bottom name-field">
				<span>별명</span>
				<mg-input class="input-common input-right" hide-label value="{{name}}" autofocus required valid="[[isNameValid]]"></mg-input>
				<mg-checkbox class="common-checkbox" id="name-valid"></mg-checkbox>
			</div>

			<div class="div-border-bottom">
				<span>성별</span>
				<span class="span-center">남자</span>
				<mg-checkbox class="common-checkbox" id="gender-male-check" checked="[[isMale]]"></mg-checkbox>
				<span class="span-center">여자</span>
				<mg-checkbox class="common-checkbox" id="gender-female-check" checked="[[!isMale]]"></mg-checkbox>
			</div>

			<div class="div-border-bottom div-margin-bottom">
				<span>생일</span>
				<mg-input class="input-common input-right" hide-label type="date" value="{{birthDate}}" required valid="[[isBirthDateValid]]"></mg-input>
			</div>

			<div class="div-border-bottom">
				<span>이메일</span>
				<mg-input class="input-common input-right" hide-label type="email" value="{{email}}" required valid="[[isEmailValid]]"></mg-input>
			</div>

			<div class="div-border-bottom">
				<span class="password-span">비밀번호</span>
				<mg-input class="input-common input-right" hide-label type="password" value="{{password}}"></mg-input>
			</div>

			<div class="div-border-bottom div-margin-bottom">
				<span class="password-span">비밀번호 확인</span>
				<mg-input class="input-common input-right" hide-label type="password" value="{{confirmPassword}}"></mg-input>
			</div>

			<div class="div-border-bottom phone-field">
				<span class="national-code">+82</span> <!-- TODO: 국가번호 코드화 -->
				<mg-input class="input-common input-center" hide-label type="tel" value="{{phoneNum}}" placeholder="휴대전화"></mg-input>
				<mg-button button-text="인증번호"></mg-button>
			</div>

			<div class="div-border-bottom div-margin-bottom">
				<span>인증번호 입력</span>
				<mg-input class="input-common input-center" hide-label value="{{authNumber}}"></mg-input>
				<mg-button button-text="확 인"></mg-button>
			</div>

			<div class="submit-btn-field">
				<mg-button button-text="참여하기" on-tap="_signUp"></mg-button>
			</div>
		</div>
	</template>
	<script>
		Polymer({
			is: 'sign-up',

			properties: {
				account: {
					type: String
				},

				name: {
					type: String
				},

				isMale: {
					type: Boolean
				},				

				birthDate: {
					type: String,
					value: function() {
						return new Date();
					}
				},

				password: {
					type: String
				},

				confirmPassword: {
					type: String
				},

				isPwdValid: {
					type: Boolean,
					value: false
				},

				email: {
					type: String
				}
			},

			observers: [
				'isPasswordValid(password, confirmPassword)'
			],

			listeners: {
				'sign-up-ajax.response': 'signUpResponsed'
			},

			_closeBtnTapped: function() {
				page('/sign_in');
			},

			changeProfilePicture: function() {
				// Cordova 환경에서 실행
				if(navigator.camera) {
					var options = {
		        quality: 100,
		        destinationType: Camera.DestinationType.FILE_URI,
		        sourceType: Camera.PictureSourceType.PHOTOLIBRARY,
		        allowEdit: true,
		        encodingType: Camera.EncodingType.PNG,
		        saveToPhotoAlbum: false
					};

					navigator.camera.getPicture(function(fileURL) {
						var options = new FileUploadOptions();
						options.fileKey = 'profile';
						options.fileName = fileURL.substr(fileURL.lastIndexOf('/') + 1);
						options.mimeType = 'image/png';

						var ft = new FileTransfer();
						ft.upload(fileURL, encodeURI(window.localStorage.baseUrl + '/users/profile'), function() {
							console.log('success');
						}, function(error) {
							console.error(error);
						}, options);

					}, function(error) {
						throw error;
					}, options);					
				} else { // Bowser 환경에서 실행
					this.$['upload-input'].click();
				}
			},

			_fileSelected: function(event) {
				var file =  event.target.files[0];
				console.log(file);
			},		

			_signUp: function() {
				if(this.valdationCheck()) {
					var signUpAjax = this.$['sign-up-ajax'];
					signUpAjax.body = {
						name: this.name,
						birthDate: this.birthDate,
						email: this.email,
						password: this.password
						// confirmPassword: this.confirmPassword,
						// phoneNum: this.phoneNum,
						// authNumber: this.authNumber					
					};

					signUpAjax.generateRequest();
				}
			},

			valdationCheck: function() {
				return true;
				// return (this.name && this.gender && this.birthDate && )
			},

			isPasswordValid: function(password, confirmPassword) {
				var pwdSpans = document.querySelectorAll('.password-span');

				if(password === confirmPassword) {
					pwdSpans.forEach(function(pwdSpan) { pwdSpan.style.color = 'black';	});

					this.isPwdValid = true;
				} else {
					pwdSpans.forEach(function(pwdSpan) { pwdSpan.style.color = 'red';	});

					this.isPwdValid = false;
				}
			},

			signUpResponsed: function(response) {
				this.fire('spinner-toggle', false);
				if(response) {
					app.route = 'sign_in';
					this.fire('toast-toggle', 'Success to Sign Up');
				} else {
					this.fire('toast-toggle', 'Faield to Sign Up');
				}
			}
		})
	</script>
</dom-module>
