<dom-module id="new-poll">
  <template>
    <style>
      #container {
        background-color: #FFFFFF;
      }
      .row-flex {
        display: flex;
        flex-direction: row;
      }
      .column-flex {
        display: flex;
        flex-direction: column;
      }      
      mg-input {
        --mg-input-border: none;
        --mg-font-size: 14pt;
      }
      .small-input {
        --mg-font-size: 12pt;
      }
      .flex-width {
        --mg-input-width: 100%;
      }
      div {
        align-items: center;
      }
      .input-right {
        --mg-input-text-align: right;
      }
      .limit-input {
        --mg-input-width: 20vw;
      }
      .default-padding {
        padding: 3%;
      }
      .full-width {
        width: 100%;
      }
      .label {
        width: 34vw;
      }
      .grey-color {
        color: #939499;
      }
      .theme-color {
        color: #39B1A8;
      }
      .border-bottom {
        border-bottom: 1px #C2C4C7 solid;
      }
      .picture-img {
        height: 3vh;
      }
      .plus-img {
        margin: auto;
        height: 3vh;
      }
      .content-section {
        min-height: 15vh;
        border: none;
        display: block;
        margin: auto;
        width: 94%;
        font-size: 12pt;
        resize: none;
      }
      .main-preview {
        display: none;
        margin: auto;
        width: 90%;
        height: auto;
      }      
      .preview {
        display: none;
        width: 40vw;
        padding-top: 3%;
      }
      .preview-margin {
        margin: auto;
        padding: 5%;
      }
      mg-button {
        --mg-button-border-radius: 0px;
        --mg-button-width: 24vw;
        --mg-button-height: 4vh;
        --mg-button-font-size: 2.8vh;
        --mg-button-color: #32B6B0;
      }      
      mg-checkbox {
        --mg-checkbox-size: 5vw;
        --mg-checkbox-bg: url('../../assets/images/check_box_off.png') no-repeat;
        --mg-checkbox-bg-checked: url('../../assets/images/check_box_on.png') no-repeat;
      }
      .invalid {
        border-radius: 5px;
        border: 1px #FF0000 solid;
      }
      .del-btn {
        display: none;
        position: absolute;
        right: -20vw;
        background-color: red;
        width: 20vw;
        height:100%;
        text-align: center;
      }
      .del-text {
        display: table-cell;
        vertical-align: middle;
        color: #FFFFFF;
      }
      #option-wrapper {
        position: relative;
        animation-duration: 0.5s
      }
      #submit-section {
        background: linear-gradient( to bottom, #3BB5A3, #00A2D9 )
      }
      .submit-btn {
        display: block;
        margin: auto;
        height: 3.6vh;
      }
      .spacer {
        flex: 1;        
      }      
      @keyframes slide {
        from {
          left: 0vw;
        }
        to {
          left: -20vw;
        }
      }
      @keyframes slide-back {
        from {
          left: -20vw;
        }
        to {
          left: 0vw;
        }
      }      
    </style>

    <custom-ajax
      id="poll-regist-ajax"
      resource-url="polls"
      content-type="application/json"
      method="POST">
    </custom-ajax>

    <custom-ajax
      id="option-regist-ajax"
      resource-url="options"
      content-type="application/json"
      method="POST">
    </custom-ajax>

    <custom-ajax
      id="upload-ajax"
      method="POST"
      resource-url="polls/thumbnails">
    </custom-ajax>

    <div id="container">
      <div class="row-flex default-padding border-bottom">
        <span class="label grey-color">제목</span>
        <mg-input id="name-input" class="flex-width" hide-label value="{{name}}"></mg-input>
      </div>

      <div class="row-flex default-padding border-bottom">
        <div style="width: 33%">
          <span class="label grey-color">마감 일시</span>
        </div>
        <div style="display: block; margin: auto;">
          <mg-input id="date-input" class="small-input" hide-label type="date" value="{{expireDate}}"></mg-input>
        </div>
        <div style="display: block; margin: auto;">
          <mg-input id="time-input" class="small-input" hide-label type="time" value="{{expireTime}}"></mg-input>
        </div>
      </div>

      <div class="row-flex default-padding border-bottom">
        <span class="full-width">복수 선택 가능</span>
        <mg-input id="limit-input" class="input-right input-right" hide-label type="number" min="[[minLimit]]" max="[[maxLimit]]" placeholder="2"  value="{{multyCheckLimit}}" hidden="[[isHideMultyCheck]]"></mg-input>
        <span style="padding-right: 5%;" hidden="[[isHideMultyCheck]]">개</span>
        <mg-checkbox on-tap="_multyCheckTapped"></mg-checkbox>
      </div>

      <div class="column-flex default-padding border-bottom">
        <div class="row-flex full-width">
          <span class="full-width">메인 이미지</span>
          <img id="main-delete-icon" class="picture-img" hidden src="../../assets/images/close.png" on-tap="_mainImageDeleteBtnTapped"/>
          <img id="main-icon" class="picture-img" src="../../assets/images/image_btn.png" on-tap="_openMainImageSelector" />
          <input id="main-image-input" type="file" on-change="_mainImageSelected" accept="image/*" hidden>
        </div>
        <img id="main-preview" class="main-preview" />
      </div>

      <div class="border-bottom">
        <textarea id="description" class="content-section default-padding" placeholder="설문 내용을 입력해 주세요."></textarea>
      </div>

      <div id="option-container">
        <div class="column-flex default-padding border-bottom">
          <div id="option-wrapper" class="column-flex full-width">
            <div class="row-flex full-width">
              <span>1.</span>
              <mg-input class="flex-width" hide-label placeholder="선택지를 작성해 주세요."></mg-input>
              <img id="delete-icon-1" class="picture-img" hidden src="../../assets/images/close.png" on-tap="_imageDeleteBtnTapped"/>
              <img id="upload-icon-1" class="picture-img" src="../../assets/images/image_btn.png" on-tap="_openImageSelector" />
              <input id="upload-input-1" type="file" on-change="_imageSelected" accept="image/*" hidden>
            </div>
            <img class="preview" id="preview-1" />
          </div>
        </div>

        <div class="column-flex default-padding border-bottom">
          <div id="option-wrapper" class="column-flex full-width"> 
            <div class="row-flex full-width">
              <span>2.</span>
              <mg-input class="flex-width" hide-label placeholder="선택지를 작성해 주세요."></mg-input>
              <img id="delete-icon-2" class="picture-img" hidden src="../../assets/images/close.png" on-tap="_imageDeleteBtnTapped"/>
              <img id="upload-icon-2" class="picture-img" src="../../assets/images/image_btn.png" on-tap="_openImageSelector" />
              <input id="upload-input-2" type="file" on-change="_imageSelected" accept="image/*" hidden>
            </div>
            <img class="preview" id="preview-2" />
          </div>
        </div>

        <template is="dom-repeat" items="{{options}}">  
          <div class="column-flex border-bottom">
            <div id="option-wrapper" class="column-flex full-width" on-track="_handleTrack">
              <div class="row-flex full-width">
                <div class="row-flex default-padding" style="position: relative; width: 100%">
                  <span>[[_displayIndex(index)]].</span>
                  <mg-input class="flex-width" hide-label placeholder="선택지를 작성해 주세요."></mg-input>
                  <img id="[[_setDeleteIconId(index)]]" class="picture-img" hidden src="../../assets/images/close.png" on-tap="_imageDeleteBtnTapped"/>
                  <img id="[[_setImgId(index)]]" class="picture-img" src="../../assets/images/image_btn.png" on-tap="_openImageSelector" />
                  <input id="[[_setInputId(index)]]" type="file" on-change="_imageSelected" accept="image/*" hidden>  
                </div>
                <div class="del-btn" index="[[index]]" on-tap="_deleteOptionTapped">
                  <span class="full-width del-text">삭 제</span>
                </div>
              </div>
            <img class="preview" id="[[_setPreviewId(index)]]" />            
            </div>
          </div>
          
        </template>
      </div>

      <div class="border-bottom">
       <img class="row-flex default-padding plus-img" src="../../assets/images/plus.png" on-tap="_addOptionTapped" />
      </div>

      <div class="row-flex default-padding border-bottom">
       <span class="label theme-color"># Tag</span>
       <mg-input id="tags-input" class="flex-width grey-color input-right" hide-label value="{{tags}}"></mg-input>
      </div>

      <div id="submit-section" class="row-flex default-padding" on-tap="_registPoll">
        <img class="submit-btn" src="../../assets/images/check_image.png" />
      </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'new-poll',

      properties: {

        minLimit: {
          type: Number,
          value: 2
        },

        maxLimit: {
          type: Number,
          value: 2
        },

        multyCheckLimit: {
          type: Number,
          value: 1
        },

        isHideMultyCheck: {
          type: Boolean,
          value: true
        },

        options: {
          type: Array,
          value: []
        },

        isNameInvalid: {
          type: Boolean,
          observer: '_isNameInvalidChanged'
        },

        isExpireDateInvalid: {
          type: Boolean,
          observer: '_isExpireDateInvalidChanged'
        },

        isExpireTimeInvalid: {
          type: Boolean,
          observer: '_isExpireTimeInvalidChanged'
        },

        isDescriptionInvalid: {
          type: Boolean,
          observer: '_isDescriptionInvalidChanged'
        },

        isOptionsInvalid: {
          type: Boolean,
          observer: '_isOptionsInvalidChanged'
        },

        isTagsInvalid: {
          type: Boolean,
          observer: '_isTagsInvalidChanged'
        },

        baseUrl: {
          type: String,
          value: function() {
            return window.localStorage.baseUrl ? window.localStorage.baseUrl : 'http://localhost:3000';
          }
        }
      },

      listeners: {
        'poll-regist-ajax.response': '_pollAjaxResponsed'
      },

      ready: function() {
        /**
         * 슬라이드 되어 있는 삭제 버튼이 있을때의 탭 이벤트 처리
         */
        this.addEventListener('tap', function() {
          if(this.slideElement) this._checkSlide();
        }.bind(this));

        /**
         * 슬라이드 백 에니메이션 발생 이후 삭제 버튼을 보이지 않도록 처리
         * 슬라이드 백이 되기 전에 버튼이 사라지는 부자연 스러운 에니메이션을 보완
         */
        this.addEventListener('animationend', function(event) {
          if(event.animationName == 'slide-back') {
            event.target.querySelector('div.del-btn').style.display = 'none';
          }
        }.bind(this));
      },

      /**
       * 추가된 선택지 로우를 삭제하기 위한 트랙 핸들러
       * 에니메이션을 수행하고 this.slideElement에 slide된 엘리먼트를 초기화해 둔다.
       * 또다시 트래킹 이벤트가 발생하면 이전에 초기화한 slide 엘리멑트를 원상 복구한다.
       * @param  Object event
       */
      _handleTrack: function(event) {
        var target = event.currentTarget;
        var state = event.detail.state;

        if(state == 'end') {
          if(event.detail.dx) {
            var dx = event.detail.dx;

            if (dx <= -100) {
              target.style.animationName = 'slide';
              target.style.left = '-20vw';
              target.querySelector('div.del-btn').style.display = 'flex';

              if(this.slideElement) {
                this.slideElement.style.animationName = 'slide-back';
                this.slideElement.style.left = '0vw';
              }              

              this.slideElement = target;
            };
          };
        };
      },

      /**
       * slideElement의 값이 있다면 현재 화면에서 발생하는 모든 탭 이벤트들을 받아
       * slide 된 선택지 로우를 원상복구 하고 this.slideElement의 값을 null 로 초기화
       */
      _checkSlide: function() {
        this.slideElement.style.animationName = 'slide-back';
        this.slideElement.style.left = '0vw';
        this.slideElement = null;
      },

      /**
       * dom repeat의 번호를 표시하기 위해 index 값을 계산한다.
       * 기본 두개의 옵션이 나와 있기 때문에 3을 더해 배열의 인덱스를 2부터 시작하도록 
       * 
       * @param  Integer index dom-repeat의 item array index
       */
      _displayIndex: function(index) {
        return index + 3;
      },

      /**
       * dom repeat에 생성되는 preview 엘리먼트의 아이디를 계산하여 설정한다.
       * 
       * @param  Integer index dom-repeat의 item array index
       */
      _setPreviewId: function(index) {
        return 'preview-' + (index + 3);
      },

      /**
       * dom repeat에 생성되는 img 엘리먼트의 아이디를 계산하여 설정한다.
       * 
       * @param  Integer index dom-repeat의 item array index
       */
      _setImgId: function(index) {
        return 'upload-icon-' + (index + 3);
      },

      /**
       * dom repeat에 생성되는 input 엘리먼트의 아이디를 계산하여 설정한다.
       * 
       * @param  Integer index dom-repeat의 item array index
       */
      _setInputId: function(index) {
        return 'upload-input-' + (index + 3);
      },

      /**
       * dom repeat에 생성되는 img 엘리먼트의 아이디를 계산하여 설정한다.
       * @param Integer index dom-repeat의 item array index
       */
      _setDeleteIconId: function(index) {
        return 'delete-icon-' + (index +3);
      },

      /**
       * add question 버튼을 누르면 실행되는 함수
       *
       * 비어있는 오브젝트를 생성하여 options에 append하고
       * 복수 선택 가능 수량을 변경한다. 현재 options의 길이에 2 더한 값 (초기 두개의 옵션 때문에)
       *
       * @param Object event
       */
      _addOptionTapped: function(event) {
        if(this.options.length < 8) {
          var newOption = {};
          this.push('options', newOption);
          this.maxLimit = this.options.length + 2;          
        } else {
          alert('최대 선택지 수량을 초과할 수 없습니다.');
        }

      },

      _deleteOptionTapped: function(event) {
        var index = event.currentTarget.index;
        this.splice('options', index, 1);
      },

      /**
       * image upload 버튼 클릭시 실행된다.
       * 메인 이미지를 업로드하는 인풋을 토글함
       * 
       * @param  Object event
       */
      _openMainImageSelector: function(event) {
        // Cordova 카메라 플러그인 처리
        if(navigator.camera) {
          var options = {
            quality: 100,
            destinationType: Camera.DestinationType.FILE_URI,
            sourceType: Camera.PictureSourceType.PHOTOLIBRARY,
            allowEdit: true,
            encodingType: Camera.EncodingType.PNG,
            saveToPhotoAlbum: false
          };

          var mainImgBtnElement = event.currentTarget;
          var mainDeleteBtnElement = this.$['main-delete-icon'];
          var previewElement = this.$['main-preview'];

          navigator.camera.getPicture(function(fileURL) {
            previewElement.src = fileURL;
            previewElement.classList.add('preview-margin');
            previewElement.style.display = 'block';

            mainDeleteBtnElement.removeAttribute('hidden');
            mainImgBtnElement.setAttribute('hidden', true);
          }, function(error) {
            throw error;
          }, options);
        } else {  // 브라우저 처리
          this.$['main-image-input'].click();
        }
      },

      /**
       * image upload 버튼 클릭시 실행된다.
       * 선택지 이미지를 업로드하는 인풋을 토글함
       * 
       * @param  Object event
       */
      _openImageSelector: function(event) {
        var iconId = event.target.id;
        var index = iconId.replace('upload-icon-', '');

        // Cordova 카메라 플러그인 처리
        if(navigator.camera) {
          var options = {
            quality: 100,
            destinationType: Camera.DestinationType.FILE_URI,
            sourceType: Camera.PictureSourceType.PHOTOLIBRARY,
            allowEdit: true,
            encodingType: Camera.EncodingType.PNG,
            saveToPhotoAlbum: false            
          };

          var imgBtnElement = event.currentTarget;
          var previewElement = document.querySelector('#preview-' + index);
          var deleteBtnElement = document.querySelector('#delete-icon-' + index);

          navigator.camera.getPicture(function(fileURL) {
            previewElement.src = fileURL;
            previewElement.classList.add('preview-margin');
            previewElement.style.display = 'block';

            imgBtnElement.setAttribute('hidden', true);
            deleteBtnElement.removeAttribute('hidden');
          }, function(error) {
            throw error;
          }, options);
        } else { // 브라우저 처리
          var inputId = 'upload-input-' + index;
          var input = document.querySelector('#' + inputId);          
          input.click();          
        }
      },

      /**
       * file input의 값이 변경되었을 때 호출된다.
       * file의 URL을 뽑아 메인 이미지의 preview를 출력한다.
       * 
       * @param  Object event
       */
      _mainImageSelected: function(event) {
        this.$['main-icon'].setAttribute('hidden', true);
        this.$['main-delete-icon'].removeAttribute('hidden');
        this.$['main-preview'].src = URL.createObjectURL(event.target.files[0]);
        this.$['main-preview'].classList.add('preview-margin');
        this.$['main-preview'].style.display = 'block';
      },

      /**
       * file input의 값이 변경되었을 때 호출된다.
       * file의 URL을 뽑아 선택지 이미지의 preview를 출력한다.
       *
       * @param  Object event
       */
      _imageSelected: function(event) {
        var inputId = event.target.id;
        var index = inputId.replace('upload-input-', '');
        var previewElement = document.querySelector('#preview-' + index);
        document.querySelector('#upload-icon-' + index).setAttribute('hidden', true);
        document.querySelector('#delete-icon-' + index).removeAttribute('hidden');
        previewElement.src = URL.createObjectURL(event.target.files[0]);
        previewElement.classList.add('preview-margin');
        previewElement.style.display = 'block';
      },

      /**
       * 메인 이미지의 삭제 버튼 누를때 실행
       * 이미지를 지우고 스타일을 원복함
       */
      _mainImageDeleteBtnTapped: function(event) {
        this.$['main-preview'].src = '';
        this.$['main-preview'].classList.remove('preview-margin');
        this.$['main-preview'].style.display = 'none';
        var mainDeleteBtnElement = event.currentTarget;
        mainDeleteBtnElement.setAttribute('hidden', true);
        this.$['main-icon'].removeAttribute('hidden');
      },

      /**
       * 이미지의 삭제 버튼 누를때 실행
       * 이미지를 지우고 스타일을 원복함
       */
      _imageDeleteBtnTapped: function(event) {
        var deleteBtnElement = event.currentTarget;
        var deleteBtnId = deleteBtnElement.id;
        var index = deleteBtnId.replace('delete-icon-', '');
        var previewElement = document.querySelector('#preview-' + index);
        var imageBtnElement = document.querySelector('#upload-icon-' + index);
        previewElement.src = '';
        previewElement.classList.remove('preview-margin');
        previewElement.style.display = 'none';
        deleteBtnElement.setAttribute('hidden', true);
        imageBtnElement.removeAttribute('hidden');
      },

      /**
       * 설문 등록 버튼 클릭시 실행된다.
       * 벨리데이션에 통과하면 Poll만 등록하는 Ajax를 호출한다.
       * 정상적으로 설문이 등록되고 나면 해당 ajax의 response 핸들러에서 선택지 저장 ajax를 수행한다.
       */
      _registPoll: function() {
        if(this.validationCheck()) {
          this.fire('mg-spinner-active');
          var params = {
            name: this.name,
            description: this.$['description'].value,
            expireDate: this.expireDate,
            expireTime: this.expireTime,
            multyCheckLimit: this.multyCheckLimit,
            tags: this.tags
          };

          if(navigator.camera) { // Cordova 처리
            var fileURL = this.$['main-preview'].src ? this.$['main-preview'].src : null;
            if(fileURL) { // Cordova && 이미지 있을 때
              var options = new FileUploadOptions();
              options.fileKey = 'mainthumbnail';
              options.fileName = fileURL.substr(fileURL.lastIndexOf('/') + 1);
              options.mimeType = 'image/png';
              options.params = params;

              var ft = new FileTransfer();
              ft.upload(fileURL, encodeURI(this.baseUrl + '/polls'), function(event) {
                var response = JSON.parse(event.response);
                this._registOption(response.id);
              }.bind(this), function(error) {
                throw error;
              }, options);
            } else { // Cordova && 이미지 없을 때
              var pollRegistAjax = this.$['poll-regist-ajax'];
              pollRegistAjax.body = params;
              pollRegistAjax.contentType = 'application/json';
              pollRegistAjax.generateRequest();
            }
          } else { // 브라우저 처리
            var formData = new FormData();
            var mainthumbnail = document.querySelector('#main-image-input').files[0];

            if(mainthumbnail) formData.append('mainthumbnail', mainthumbnail);
            formData.append('name', this.name);
            formData.append('description', this.$['description'].value);
            formData.append('expireDate', this.expireDate);
            formData.append('expireTime', this.expireTime);
            formData.append('tags', this.tags);
            formData.append('multyCheckLimit', this.multyCheckLimit);

            var pollRegistAjax = this.$['poll-regist-ajax'];
            pollRegistAjax.body = formData;
            pollRegistAjax.contentType = undefined;
            pollRegistAjax.generateRequest();      
          }
        }
      },

      /**
       * Cordova FileTransfer 정상 처리시 호출된다. (Cordova 처리)
       * @param  Number pollId
       */
      _registOption: function(pollId) {
        var optWrappers = document.querySelectorAll('#option-wrapper');

        for(var i = 0; i < optWrappers.length; i++) {
          var name = optWrappers[i].querySelector('mg-input').value;
          var params = { name: name, pollId: pollId };
          var fileURL = optWrappers[i].querySelector('.preview').src ? optWrappers[i].querySelector('.preview').src : null;

          if(fileURL) { // Cordova && 이미지 있을 때
            var options = new FileUploadOptions();
            options.fileKey = 'thumbnail';
            options.fileName = fileURL.substr(fileURL.lastIndexOf('/') + 1);
            options.mimeType = 'image/png';
            options.params = params;

            var ft = new FileTransfer();
            ft.upload(fileURL, encodeURI(this.baseUrl + '/options'), null, null, options);
          } else { // Cordova && 이미지 없을 때
            var optionRegistAjax = this.$['option-regist-ajax'];
            optionRegistAjax.body = params;
            optionRegistAjax.contentType = 'application/json';
            optionRegistAjax.generateRequest();
          };
        };
        this._transactionFinished();
      },

      /**
       * 브라우저 이미지 있거나 없을때 && Cordova 이미지 없이 Poll 등록 했을 때 호출
       * @param  Object event response Object
       */
      _pollAjaxResponsed: function(event) {
        var pollId = event.detail.response.id;
        var optWrappers = document.querySelectorAll('#option-wrapper');

        for(var i = 0; i < optWrappers.length; i++) {
          var name = optWrappers[i].querySelector('mg-input').value;
          var params = { name: name, pollId: pollId };

          if(navigator.camera) { // Cordova 처리
            var fileURL = optWrappers[i].querySelector('.preview').src ? optWrappers[i].querySelector('.preview').src : null;

            if(fileURL) { // Cordova && Preview 이미지 있을 때 처리 
              var options = new FileUploadOptions();
              options.fileKey = 'thumbnail';
              options.fileName = fileURL.substr(fileURL.lastIndexOf('/') + 1);
              options.mimeType = 'image/png';
              options.params = params;

              var ft = new FileTransfer();
              ft.upload(fileURL, encodeURI(this.baseUrl + '/options'), null, null, options);
            } else { // Cordove && Preview 이미지 없을 때 처리
              var optionRegistAjax = this.$['option-regist-ajax'];
              optionRegistAjax.body = params;
              optionRegistAjax.generateRequest();
            }

          } else { // Browser일 때 처리
            var thumbnail = optWrappers[i].querySelector('input[type=file]').files[0];
            var formData = new FormData();
            if(thumbnail) formData.append('thumbnail', thumbnail);
            formData.append('name', name);
            formData.append('pollId', pollId);

            var optionRegistAjax = this.$['option-regist-ajax'];
            optionRegistAjax.body = formData;
            optionRegistAjax.contentType = undefined;
            optionRegistAjax.generateRequest();            
          }
        };
        this._transactionFinished();
      },

      /**
       * 설문 등록 transaction이 완료 되었을 때 호출
       * 라우팅 변경과 스피너 제거를 수행한다.
       */
      _transactionFinished: function() {
        this.clearValues();
        page('/main');
        document.dispatchEvent(new Event('mg-spinner-deactive'));
        document.dispatchEvent(new Event('mg-tab-view-selected'));        
      },

      /**
       * transaction 완료 후 호출되는 function
       * 폼에 설정한 모든 값들을 초기화 합니다.
       */
      clearValues: function() {
        this.name = undefined;
        this.$['description'].value = undefined;
        this.expireDate = undefined;
        this.expireTime = undefined;
        this.tags = undefined;
        this.multyCheckLimit = 1,
        this.options = []
      },

      /**
       * poll regist ajax 호출 전에 수행하는 validation
       * 각 필드의 validation check 함수를 호출하고 결과에 따라 isSomthingInvalid를 초기화 한다.
       * 해당 변수를 통해 validation 수행 결과를 사용자에게 보여준다.
       * 
       * @return Boolean validation 결과 
       */
      validationCheck: function() {
        if(this._checkNameInvalid()) return false;
        if(this._checkExpireDateInvalid()) return false;
        if(this._checkExpireTimeInvalid()) return false;
        if(this._checkDescriptionInvalid()) return false;
        if(this._checkOptionsInvalid()) return false;
        if(this._checkTagsInvalid()) return false;
        return true;
      },

      /**
       * name validation
       * name의 null 여부 확인
       * 
       * @return Boolean
       */
      _checkNameInvalid: function() {
        if(this.name) {
          return this.isNameInvalid = false;
        }
        return this.isNameInvalid = true;
      },

      /**
       * expireDate validation
       * expireDate null 여부 오늘 이전 날짜 여부 확인
       * 
       * @return Boolean
       */
      _checkExpireDateInvalid: function() {
        if(this.expireDate) {
          var dateArray = this.expireDate.split('-');
          var year = dateArray[0];
          var month = dateArray[1];
          var day = dateArray[2];

          var formatedDate = new Date(year, month, day);
          var today = new Date();
          today.setHours(0, 0, 0, 0);

          if(formatedDate >= today) {
            return this.isExpireDateInvalid = false;
          }          
        }
        return this.isExpireDateInvalid = true;
      },

      /**
       * expireTime validation
       * expireTime null 여부 확인
       * 
       * @return Boolean
       */
      _checkExpireTimeInvalid: function() {
        if(this.expireTime) {
          return this.isExpireTimeInvalid = false;
        }
        return this.isExpireTimeInvalid = true;
      },

      /**
       * description validation
       * description null 여부 확인
       * 
       * @return Boolean
       */
      _checkDescriptionInvalid: function() {
        if(this.$['description'].value) {
          return this.isDescriptionInvalid = false;
        }
        return this.isDescriptionInvalid = true;
      },

      /**
       * options validation
       * options null 여부 확인
       * 
       * @return Boolean
       */
      _checkOptionsInvalid: function() {
        var optWrappers = document.querySelectorAll('#option-wrapper');
        var result = false;

        optWrappers.forEach(function(optWrapper) {
          var nameInput = optWrapper.querySelector('mg-input');
          if(!nameInput.value) {
            result = true;
          }
        });

        if(result) {
          return this.isOptionsInvalid = true;
        };
        return this.isOptionsInvalid = false;
      },

      /**
       * tag validation
       * tag null 여부 확
       * 
       * @return Boolean
       */
      _checkTagsInvalid: function() {
        if(this.tags) {
          return this.isTagsInvalid = false;
        }
        return this.isTagsInvalid = true;
      },

      /**
       * multy check checkbox tap 시 실행
       * checkbox의 값에 따라 limit-input을 숨기거나 보여준다.
       * 만약 limit-input값이 나타난다면 초기값을 입력한다 (반드시 2 이상이기 때문에 2가 초기값)
       * 
       * @param  Object event
       */
      _multyCheckTapped: function(event) {
        var checkbox = event.target;
        if(checkbox.checked) {
          this.isHideMultyCheck = false;
          this.$['limit-input'].value = 2;
        } else {
          this.isHideMultyCheck = true;
        }
      },

      _isNameInvalidChanged: function(invalid) {
        if(invalid) this._showInvalidDialog(this.$['name-input']);
      },

      _isExpireDateInvalidChanged: function(invalid) {
        if(invalid) this._showInvalidDialog(this.$['date-input']);
      },

      _isExpireTimeInvalidChanged: function(invalid) {
        if(invalid) this._showInvalidDialog(this.$['time-input']);
      },

      _isDescriptionInvalidChanged: function(invalid) {
        if(invalid) this._showInvalidDialog(this.$['description']);
      },

      _isOptionsInvalidChanged: function(invalid) {
        if(invalid) this._showInvalidDialog(this.$['option-container']);
      },

      _isTagsInvalidChanged: function(invalid) {
        if(invalid) this._showInvalidDialog(this.$['tags-input']);
      },

      _showInvalidDialog: function(element) {
        alert('올바른 정보를 입력해 주세요.');
        element.focus();
      }
    })
  </script>
</dom-module>
