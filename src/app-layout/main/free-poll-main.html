<link rel="import" href="routing.html">

<dom-module id="free-poll-main">
	<template>
		<style>
			:host {
				display: block;
			}
			iron-pages {
				height: 100%;
			}
			.pages {
				height: 100%;
			}
		</style>

		<app-drawer-layout fullbleed>
			<!-- Drawer content -->
			<mg-side-menu id="drawer" menu-element="free-poll-menu-list" reverse></mg-side-menu>

			<!-- Main content -->
			<app-header-layout has-scrolling-region>
				<app-header fixed>
					<free-poll-header title="[[title]]"></free-poll-header>
				</app-header>

				<iron-pages attr-for-selected="route" selected="{{route}}" on-track="handleTrack">
					<!-- view list -->
					<main-page class="pages" route="main"></main-page>
					<my-poll class="pages" route="my_polls"></my-poll>
					<new-poll class="pages" route="new_poll"></new-poll>
					<poll-list class="pages" route="polls"></poll-list>
					<poll-join class="pages" route="poll_join"></poll-join>
					<poll-charts class="pages" route="poll_charts"></poll-charts>
					<profile-view class="pages" route="profile"></profile-view>
					<sign-in class="pages" route="sign_in"></sign-in>
				</iron-pages>

			</app-header-layout>
		</app-drawer-layout>

		<!-- common utils -->
		<paper-toast id="bottom-toast" class="fit-bottom" text="[[toastMsg]]"></paper-toast>
		<dialog-opener id="dialog-opener"></dialog-opener>
		<custom-localstorage></custom-localstorage>
		<message-dialog></message-dialog>
	</template>

	<script>
		Polymer({
			is: 'free-poll-main',

			properties: {

				/**
				 * 현재 화면의 route
				 * @type {String}
				 */
				route: {
					type: String,
					observer: '_routeChanged'
				},

				/**
				 * 어플리케이션 헤더 부분에 표시되는 현재 페이지의 title
				 * @type {String}
				 */
				title: {
					type: String,
				},

				/**
				 * 서버의 baseUrl
				 * TODO: 컴퍼넌트 로드 완료 후 값을 설정하도록 수정 or 서버가 결정되면 하드코딩
				 * @type {String}
				 */
				baseUrl: {
					type: String
				}
			},

			ready: function() {
				document.addEventListener('side-menu-open', function() {
					this.openSideMenu();
				}.bind(this));

				document.addEventListener('toast-toggle', function(event) {
					var message = event.detail;
					this.toggleToast(message);
				}.bind(this));

				document.addEventListener('spinner-toggle', function(event) {
					var isActive = event.detail;
					this.toggleSpinner(isActive);
				}.bind(this));
			},

			/**
			 * 드레그 이벤트 핸들러
			 * 이벤트가 발생하면 x, y 축의 값을 계산하여
			 * swite-to-right, swipe-to-left, swipe-to-down, swipe-to-up
			 * 와 같은 이벤트를 발생시킨다.
			 * 
			 * @param  {Object} event 화면 터치 드레그에 대한 이벤트
			 */
			handleTrack: function(event) {
				var state = event.detail.state;
				if(state == 'end') {
					if(event.detail.dx) {
						var dx = event.detail.dx;
						if(dx >= 100) {
							this.fire('swipe-to-right');
						} else if (dx <= -100) {
							this.fire('swipe-to-left');
						}
					};

					if (event.detail.dy) {
						var dy = event.detail.dy;
						if(dy >= 100) {
							this.fire('swipe-to-down');
						} else if (dy <= -100) {
							this.fire('swipe-to-up');
						}
					};
				}
			},

			/**
			 * side menu drawer open
			 */
			openSideMenu: function() {
				
			},

			/**
			 * route가 변경될 때 마다 호출되며
			 * route가 my_polls일 때는 refresh-poll-list 이벤트를 발생시
			 * 화면의 poll 리스트를 다시 조회한다.
			 *
			 * route가 변경되면 side-menu를 명시적으로 close
			 * @param  {String} route
			 */
			_routeChanged: function(route) {
				if(route == 'my_polls') {
					this.fire('refresh-poll-list');
				}

				this.$.drawer.close();
			},

			/**
			 * toast toggle event listener
			 */
			toggleToast: function(message) {
				var toast = this.$['bottom-toast'];
				toast.text = message;
				toast.close();
				toast.toggle();
			},

			/**
			 * spinner toggle event listner
			 */
			toggleSpinner: function(isActive) {
				// this.$['spinner'].active = isActive;
			}
		})
	</script>
</dom-module>
