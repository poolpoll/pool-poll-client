<link rel="import" href="routing.html">

<dom-module id="free-poll-main">
	<template>
		<style>
			#spinner {
				z-index: 1;
				@apply(--layout-flex);
				@apply(--layout-center-justified);
		    @apply(--layout-self-stretch);
			}
		</style>
		<paper-drawer-panel id="drawer">
		  <paper-header-panel id="side-menu" drawer>
	    	<free-poll-menu-list></free-poll-menu-list>
		  </paper-header-panel>

		  <paper-header-panel main>
		  	<!-- header -->
		    <free-poll-header title="[[title]]"></free-poll-header>
				<!-- main -->
				<iron-pages attr-for-selected="route" selected="{{route}}" on-track="handleTrack">
					<!-- view list -->
					<main-page route="main"></main-page>
					<new-poll route="new_poll"></new-poll>
					<my-poll route="my_polls"></my-poll>
					<profile-view route="profile"></profile-view>
					<sign-in route="sign_in"></sign-in>
				</iron-pages>
				<paper-spinner id="spinner"></paper-spinner>
		  </paper-header-panel>
		</paper-drawer-panel>

		<!-- common utils -->
		<paper-toast id="bottom-toast" class="fit-bottom" text="[[toastMsg]]"></paper-toast>
		<dialog-opener id="dialog-opener"></dialog-opener>
		<custom-localstorage></custom-localstorage>
	</template>

	<script>
		Polymer({
			is: 'free-poll-main',

			properties: {

				route: {
					type: String,
					observer: '_routeChanged'
				},

				title: {
					type: String,
				},

				baseUrl: {
					type: String
				}
			},

			ready: function() {
				document.addEventListener('side-menu-open', function() {
					this.openSideMenu();
				}.bind(this));

				document.addEventListener('toast-toggle', function(event) {
					var message = event.detail;
					this.toggleToast(message);
				}.bind(this));

				document.addEventListener('spinner-toggle', function(event) {
					var isActive = event.detail;
					this.toggleSpinner(isActive);
				}.bind(this));
			},

			handleTrack: function(event) {
				var state = event.detail.state;
				if(state == 'end') {
					if(event.detail.dx) {
						var dx = event.detail.dx;
						if(dx >= 100) {
							this.fire('swipe-to-right');
						} else if (dx <= -100) {
							this.fire('swipe-to-left');
						}
					};

					if (event.detail.dy) {
						var dy = event.detail.dy;
						if(dy >= 100) {
							this.fire('swipe-to-down');
						} else if (dy <= -100) {
							this.fire('swipe-to-up');
						}
					};
				}
			},

			openSideMenu: function() {
				this.$['drawer'].openDrawer();
			},

			/**
			 * routeUrl이 변경될 때 마다 호출한다.
			 */
			_routeChanged: function(route) {
				if(route == 'my_polls') {
					this.fire('refresh-poll-list');
				}
				
				this.$['drawer'].closeDrawer();
			},

			/**
			 * toast toggle event listener
			 */
			toggleToast: function(message) {
				var toast = this.$['bottom-toast'];
				toast.text = message;
				toast.close();
				toast.toggle();
			},

			/**
			 * spinner toggle event listner
			 */
			toggleSpinner: function(isActive) {
				this.$['spinner'].active = isActive;
			}
		})
	</script>
</dom-module>