<dom-module id="free-poll-menu-header">
	<template>
		<style>
			:host {
				display: flex;
				flex-direction: column;
			}
			.container {
				@apply(--layout-flex);
				padding-top: 5%;
				padding-left: 85%;
			}
			iron-icon {
				display: block;
				margin: auto;
				width: 2.5vh;
				height: 2.5vh;
			}
			.profile-container {
				padding-bottom: 3%;
			}
			iron-image {
				display: block;
				margin: auto;
				width: 10vh;
				height: 10vh;
				border-style: solid;
				border-color: white;
				border-radius: 100%;
				--iron-image-width: 100%;
			}
			.name {
				text-align: center;
				color: #ffffff;
				font-size: smaller;
			}
			.level {
				text-align: center;
				color: #E906E1;
			}
			.level .prefix {
				color: #ffffff;
				font-size: smaller;
			}
		</style>

		<custom-ajax
			id="upload-ajax"
			method="POST"
			resource-url="users/profile">
		</custom-ajax>

		<div class="container">
			<iron-icon id="swipe-back-icon" src="./images/setting_icon.png" on-tap="settingBtnTapped"></iron-icon>
		</div>

		<div class="profile-container">
			<iron-image src="[[imageSrc]]" on-tap="changeProfilePicture"></iron-image><br>
			<div class="name">
				<span>[[userInfo.name]]</span>
			</div>
			<div class="level">
				<span class="prefix">Lv.</span><span class="level">[[userInfo.level]]</span>
			</div>
		</div>

		<input id="upload-input" type="file" on-change="_fileSelected" accept="image/*" hidden>
	</template>
	<script>
		Polymer({
			is: 'free-poll-menu-header',

			properties: {
				imageSrc: {
					type: String,
					computed: '_computeImageSrc(userInfo)'
				},

				userInfo: {
					type: Object
				}
			},

			listeners: {
				'upload-ajax.response': '_uploadResponsed'
			},

			ready: function() {
				this.userInfo = JSON.parse(localStorage.getItem('userInfo'));
			},

			settingBtnTapped: function() {
				console.log('setting button tapped');
			},

			changeProfilePicture: function() {
				var fileUpload = document.getElementById('upload-input');
				fileUpload.click();
			},

			_fileSelected: function(event) {
				var formData = new FormData();
				formData.append('profile', event.target.files[0]);

				var uploadAjax = this.$['upload-ajax'];
				uploadAjax.body = formData;
				uploadAjax.contentType = undefined;
				uploadAjax.generateRequest();
			},

			_computeImageSrc: function(userInfo) {
				// base url 전역 변수로 수정해야 함
				if(userInfo.attachmentId)	return 'http://localhost:3000/users/profile/' + userInfo.attachmentId;
			},

			_uploadResponsed: function(response) {
				this.userInfo = response.detail.response;
				this.fire('set-local-storage', { key: 'userInfo', value: this.userInfo });

			}
		})
	</script>
</dom-module>